services:

  eureka-server:
    image: eurekaserver:0.1
    ports:
      - "8761:8761"
    networks:
      - library-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  anggotaservice:
    image: anggotaservice:0.1
    ports:
      - "9001:9001"
    networks:
      - library-network
    environment:
      - SPRING_APPLICATION_NAME=anggotaservice
      - SERVER_PORT=9001
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy

  bukuservice:
    image: bukuservice:0.1
    ports:
      - "9002:9002"
    networks:
      - library-network
    environment:
      - SPRING_APPLICATION_NAME=bukuservice
      - SERVER_PORT=9002
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy

  peminjamanservice:
    image: peminjamanservice:0.1
    ports:
      - "9003:9003"
    networks:
      - library-network
    environment:
      - SPRING_APPLICATION_NAME=peminjamanservice
      - SERVER_PORT=9003
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy

  pengembalianservice:
    image: pengembalianservice:0.1
    ports:
      - "9004:9004"
    networks:
      - library-network
    environment:
      - SPRING_APPLICATION_NAME=pengembalianservice
      - SERVER_PORT=9004
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy

  api-gateway:
    image: apigateway:0.2
    ports:
      - "9006:9006"
    networks:
      - library-network
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - SERVER_PORT=9006
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
      anggotaservice:
        condition: service_started
      bukuservice:
        condition: service_started
      peminjamanservice:
        condition: service_started
      pengembalianservice:
        condition: service_started

networks:
  library-network:
    driver: bridge
